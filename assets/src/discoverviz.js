!function(t){t.data=null,t.color=d3.scale.category10(),t.draw_all=function(e,r,n){r&&!t.data&&(t.data=r),t.draw_main_topics(e[0]),t.draw_other_topics(e[1]),t.draw_groupings(e[2]),t.list_countries(e[3])};var e=document.getElementById("viz");t.getWidth=function(){return e.offsetWidth},t.getHeight=function(){return e.offsetHeight},t.draw_groupings=function(e,r){r=r||t.data;var n={top:40,right:250,bottom:70,left:50},a=t.getWidth()-n.left-n.right,o=t.getHeight()-n.top-n.bottom,i=d3.scale.linear().range([0,a]),c=d3.scale.linear().range([o,0]),u=d3.svg.axis().scale(i).orient("bottom").tickFormat(d3.format(".0f")),s=d3.svg.axis().scale(c).orient("left"),l=d3.svg.line().interpolate("cardinal").x(function(t){return i(t.year)}).y(function(t){return c(t.volume)});d3.select(e).select("svg").remove();var f=d3.select(e).append("svg").attr("width",a+n.left+n.right).attr("height",o+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");r.forEach(function(t){"string"==typeof t.actors&&(t.actors=t.actors.split("|").filter(function(t){return""!=t}))});var d={};r.forEach(function(t){d[t.year]=(d[t.year]||0)+1});var m={};r.forEach(function(t){t.actors.forEach(function(e){var r=m[e]||{},n=(r[t.year]||0)+100/d[t.year];r[t.year]=n,m[e]=r})});var p=[];for(var v in m)for(var y=1995;y<=2015;y++)p.push({actor:v,year:y,volume:m[v][y]||0});var g=d3.nest().key(function(t){return t.actor}).entries(p).filter(function(t,e){return d3.max(t.values.map(function(t){return t.volume}))>10});t.color.domain(g.map(function(t){return t.key})),i.domain(d3.extent(p,function(t){return t.year})),c.domain([d3.min(g,function(t){return d3.min(t.values,function(t){return t.volume})}),d3.max(g,function(t){return d3.max(t.values,function(t){return t.volume})})]),f.append("g").attr("class","x axis").attr("transform","translate(0,"+o+")").call(u).append("text").attr("x",a).attr("y",30).style("text-anchor","end").text("Year"),f.append("g").attr("class","y axis").call(s).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Volume (%)");var v=f.selectAll(".actor").data(g).enter().append("g").attr("class","actor");v.append("path").attr("class","line").attr("d",function(t){return l(t.values)}).style("stroke",function(e){return t.color(e.key)}),v.append("text").datum(function(t){return{name:t.key,value:t.values[t.values.length-1]}}).attr("transform",function(t){return"translate("+i(t.value.year)+","+c(t.value.volume)+")"}).attr("x",3).attr("y",function(t){return"Alliance of Small Island States"==t.name?-7:"Group of 77"==t.name?-6:"African Group"==t.name?0:"Independent association of Latin America and the Caribbean"==t.name?9:0}).attr("dy",".35em").style("fill",function(e){return t.color(e.name)}).text(function(t){return"Independent association of Latin America and the Caribbean"==t.name?"I.A. of Latin America & the Caribbean":"Organisation for Economic Co.operation and Development"==t.name?"Org. for Economic Coop. & Development":t.name})},t.draw_main_topics=function(e,r){return t.draw_topics(e,r,{"UNFCCC and Kyoto Protocol Functioning":-3,"Extension of the Kyoto protocol":-3,"Post-Kyoto Agreements":0,"Pre-Kyoto":0,"Compliance and Enforcement":-6})},t.draw_other_topics=function(e,r){return t.draw_topics(e,r,{"Vulnerabilities and Impacts":-5,"Adverse Effects and Response Measure":0,"Financial Mechanisms and Funds":0,forests:0,"Loss and Damage":0})},t.draw_topics=function(e,r,n){r=r||t.data;var a={top:40,right:250,bottom:70,left:50},o=t.getWidth()-a.left-a.right,i=t.getHeight()-a.top-a.bottom,c=(d3.time.format("%Y%m%d").parse,d3.scale.linear().range([0,o])),u=d3.scale.linear().range([i,0]),s=d3.svg.axis().scale(c).orient("bottom").tickFormat(d3.format(".0f")),l=d3.svg.axis().scale(u).orient("left"),f=d3.svg.line().interpolate("cardinal").x(function(t){return c(t.year)}).y(function(t){return u(t.volume)});d3.select(e).select("svg").remove();var d=d3.select(e).append("svg").attr("width",o+a.left+a.right).attr("height",i+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")");r.forEach(function(t){"string"==typeof t.topics&&(t.topics=t.topics.split("|").filter(function(t){return""!=t}))});var m={};r.forEach(function(t){m[t.year]=(m[t.year]||0)+1});var p={};r.forEach(function(t){t.topics.forEach(function(e){var r=p[e]||{},n=(r[t.year]||0)+100/m[t.year];r[t.year]=n,p[e]=r})});var v=[];for(var y in p)for(var g=1995;g<=2015;g++)v.push({topic:y,year:g,volume:p[y][g]||0});var h=d3.nest().key(function(t){return t.topic}).entries(v).filter(function(t,e){return Object.keys(n).indexOf(t.key)!==-1});t.color.domain(h.map(function(t){return t.key})),c.domain(d3.extent(v,function(t){return t.year})),u.domain([d3.min(h,function(t){return d3.min(t.values,function(t){return t.volume})}),d3.max(h,function(t){return d3.max(t.values,function(t){return t.volume})})]),d.append("g").attr("class","x axis").attr("transform","translate(0,"+i+")").call(s).append("text").attr("x",o).attr("y",30).style("text-anchor","end").text("Year"),d.append("g").attr("class","y axis").call(l).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Volume (%)");var y=d.selectAll(".topic").data(h).enter().append("g").attr("class","topic");y.append("path").attr("class","line").attr("d",function(t){return f(t.values)}).style("stroke",function(e){return t.color(e.key)}),y.append("text").datum(function(t){return{name:t.key,value:t.values[t.values.length-1]}}).attr("transform",function(t){return"translate("+c(t.value.year)+","+u(t.value.volume)+")"}).attr("x",3).attr("y",function(t){return n[t.name]}).attr("dy",".35em").style("fill",function(e){return t.color(e.name)}).text(function(t){return t.name})},t.list_countries=function(e,r){r=r||t.data,d3.select(e).select("div").remove();var n=d3.select(e).append("div");n.attr("id","year-history"),t.getCountryClass=function(t){return"country-"+t.country.toLowerCase().replace(/[^a-z]*/gi,"")},r.forEach(function(t){"string"==typeof t.countries&&(t.countries=t.countries.split("|").filter(function(t){return""!=t}))});var a={};r.forEach(function(t){a[t.year]=(a[t.year]||0)+1});var o={};r.forEach(function(t){t.countries.forEach(function(e){var r=o[e]||{},n=(r[t.year]||0)+100/a[t.year];r[t.year]=n,o[e]=r})});var i=[];for(var c in o)for(var u=1995;u<=2015;u++)i.push({country:c,year:u,volume:o[c][u]||0});var s=d3.nest().key(function(t){return t.year}).entries(i);s.forEach(function(t){t.values.sort(function(t,e){return e.volume-t.volume}),t.values=t.values.filter(function(t,e){return e<5})});var l={};s.forEach(function(t){t.values.forEach(function(t){l[t.country]=!0})}),t.color.domain(d3.keys(l));var u=n.selectAll(".year").data(s).enter().append("div").attr("class","year");u.text(function(t){return t.key}).selectAll(".country").data(function(t){return t.values}).enter().append("p").attr("class",function(e){return"overable "+t.getCountryClass(e)}).style("color",function(e){return t.color(e.country)}).text(function(t){return t.country+" "+Math.round(t.volume)+"%"}).on("mouseenter",function(e){document.getElementById("year-history").classList.add("overed");var r=t.getCountryClass(e);[].forEach.call(document.querySelectorAll("."+r),function(t){t.classList.add("highlight-country")})}).on("mouseleave",function(e){document.getElementById("year-history").classList.remove("overed");var r=t.getCountryClass(e);[].forEach.call(document.querySelectorAll("."+r),function(t){t.classList.remove("highlight-country")})}).append("span").style("background-color",function(e){return t.color(e.country)}).style("width",function(t){return Math.round(t.volume)+"%"})}}(window.discoverviz=window.discoverviz||{});